<style>
  label, input { display:block; }
  input.text { margin-bottom:12px; width:95%; padding: .4em; }
  fieldset { padding:0; border:0; margin-top:25px; }
  .validateTips { border: 1px solid transparent; padding: 0.3em; }
  #accordion-resizer { position: relative; padding-bottom: 15px; }
</style>

<script>
$(function() {
  var $addr = window.location.protocol + '//' + window.location.host;
  var $action = $( "#addAppForm" ).attr( "action" );
  var $title_done = 'Done!';
  var $title_error = 'An error has occured';
  var $icon_notice = '<span class="ui-icon ui-icon-notice" style="float:left; margin:3px 7px 50px 0;"></span>';
  var $icon_alert = '<span class="ui-icon ui-icon-alert" style="float:left; margin:3px 7px 50px 0;"></span>';
  var $icon_check = '<span class="ui-icon ui-icon-check" style="float:left; margin:3px 7px 50px 0;"></span>';
  var $icon_play = '<div align="center" style="margin: 0; padding: 0;"><span class="ui-icon ui-icon-play"></span></div>';
  var $errors = [
    "<p>" + $icon_notice + "Connection error. Try again later.</p>",
    "<p>" + $icon_notice + "Bad request</p>",
    "<p>" + $icon_notice + "Not implemented yet</p>",
    "<p>" + $icon_notice + "Internal error</p>",
    "<p>" + $icon_notice + "Duplicate entry</p>",
    "<p>" + $icon_notice + "Not found</p>"
  ];

  var dialog, editor, form,
    table = $( "table" ),
    tbody = $( "table tbody" ),
    name = $( "#addAppForm #name" ),
    nameRegex = /^[a-z]([0-9a-z_\s])+$/i,
    user = $( "#addAppForm #user" ),
    cmd = $( "#addAppForm #cmd" ),
    tips = $( ".validateTips" );
    
  function updateTips( t ) {
    tips
      .text( t )
      .addClass( "ui-state-highlight" );
    setTimeout( function() {
      tips.removeClass( "ui-state-highlight", 1500 );
    }, 500 );
  }
 
  function checkLength( o, n, min, max ) {
    if ( o.val().length > max || o.val().length < min ) {
      o.addClass( "ui-state-error" );
      updateTips( "Length of " + n + " must be between " 
                + min + " and " + max + "." );
      return false;
    } else {
      return true;
    }
  }
  
  function checkRegexp( o, regexp, n ) {
    if ( !( regexp.test( o.val() ) ) ) {
      o.addClass( "ui-state-error" );
      updateTips( n );
      return false;
    } else {
      return true;
    }
  }
  
  // variable number of arguments function
  function showMessage() {
    var title, text, selector;
    
    if ( arguments.length == 2 ) {
      title = arguments[0];
      text = arguments[1];
      selector = '#message';
    } else if ( arguments.length == 3 ) {
      title = arguments[0];
      text = arguments[1];
      selector = arguments[2];
    } else {
      alert( 'showMessage() error!' );
      return false;
    }
  
    var m = $( selector ).dialog( {
      dialogClass: "no-close",
      autoOpen: false,
      modal : true,
      title : title,
      width : 480,
      height : 260,
      buttons : {
        Ok : function() {
          $( this ).dialog( "close" );
        }
      },
      close : function() {
        $( selector ).empty();
        
        // remove cloned objects
        if ( selector != '#message' ) {
          $( selector ).remove();
        }
      }
    } );
    
    m.empty().append( text ).dialog( "open" );
    return false;
  }

  
  function showMessageCloned( title, text ) {
    $( '#message' ).clone( false )
    .empty()
    .attr( 'id', 'new-message' )
    .appendTo( 'body' );
    showMessage( title, text, '#new-message' );

    return false;
  }
  
  
  function confirmDialog( text, callback ) {
    var d = $( "#yesno" ).dialog( {
      dialogClass : "no-close",
      autoOpen : false,
      modal : true,
      width : 400,
      height : 300,
      buttons : {
        Confirm : function() {
          callback();
          $( this ).dialog( "close" );
        },
        Cancel : function() {
          $( this ).dialog( "close" );
        }
      },
      close : function() {
        $( "#yesno" ).empty();
      }
    } );
    
    var t = "<p>" + $icon_alert + text + "</p>";
    d.append( t ).dialog( "open" );
  }

  
  /*
   * Add application button callback
   */


  function createApp() {
    var valid = true;
    
    $( '#addAppForm :input').removeClass( "ui-state-error" );
    
    valid = valid && checkLength( name, "name", 2, 16 );
    valid = valid && checkRegexp( name, nameRegex,
      "Username may consist of a-z, 0-9, underscores, spaces and must begin with a letter." );
    valid = valid && checkLength( user, "user", 1, 16 );
    valid = valid && checkLength( cmd, "command", 1, 256 );
        
    if ( valid ) {
      $.ajax( {
        url: $addr + $action,
        type: "POST",
        async: true,
        data: $( "#addAppForm" ).serialize(),
        dataType: "json",
        cache: false,
      } )
      .done( function ( data, textStatus, jqXHR ) {
        if ( data.name ) {
          addEntryIntoTable( name, user, cmd );
          dialog.dialog( "close" );
        } else {
          showMessage( $title_error, $errors[ data.err ] );
        }
      } )
      .fail( function ( xhr, textStatus, errorThrown ) {
        showMessage( $title_error, $errors[ 0 ] );
      } );
    }

    return valid;
  }
  
  function addEntryIntoTable( n, u, c ) {
    var row = '<tr><td>' + n.val()
      + '</td><td>' + u.val()
      + '</td><td>' + c.val()
      + '</td><td id="runApp">' + $icon_play + '</td></tr>',
    $row = $( row ),
    resort = true;

    table.find( 'tbody' ).append( $row )
    .trigger( 'addRows', [ $row, resort ] );
    
    // register on click event to show dialog window
    // about an entry
    setCellEvents();

    return false;
  }


  /*
   * Edit application show entry callback
   */


  function editApp( entry ) {
    var valid = true;

    $( '#editAppForm :input' ).removeClass( "ui-state-error" );
    var u = $( '#editAppForm #user' ),
        c = $( '#editAppForm #cmd' );

    valid = valid && checkLength( u, "user", 1, 16 );
    valid = valid && checkLength( c, "command", 1, 256 );

    if ( valid ) {
      $.ajax( {
        url: $addr + $action,
        type: "POST",
        async: true,
        data: $( "#editAppForm" ).serialize(),
        dataType: "json",
        cache: false,
      } )
      .done( function ( data, textStatus, jqXHR ) {
        if ( data.name ) {
          // TODO
          //editEntryTable( n, u, c );
          loadEntries();
          editor.dialog( "close" );
        } else {
          showMessage( $title_error, $errors[ data.err ] );
        }
      } )
      .fail( function ( xhr, textStatus, errorThrown ) {
        showMessage( $title_error, $errors[ 0 ] );
      } );
    }

    return valid;
  }


  /*
   * Delete application show entry callback
   */


   function delApp() {
      var n = $( '#editAppForm #name' ).val();
      
      $.ajax( {
        url : $addr + $action,
        type : 'POST',
        async : true,
        data : { action : 'delApp', name : n },
        dataType : 'json',
        cache : false
      } )
      .done( function ( data, textStatus, jqXHR ) {
        if ( data.name ) {
          // TODO
          //deleteEntryFromTable( data.name );
          loadEntries();
          editor.dialog( 'close' );
        } else {
          showMessage( $title_error, $errors[ data.err ] );
        }
      } )
      .fail( function ( xhr, textStatus, errorThrown ) {
        showMessage( $title_error, $errors[ 0 ] );
      } );
   }


  /*
   * Find application name
   */
  
  
  function findAppName( el ) {
    var e = el;
    var steps = 5;
    var n;
  
    for ( var i = 0; i < steps; i++ ) {
      var t = e.parentNode;

      if ( t.nodeName == 'TR' ) {
        n = $( t ).children().first().text();
        break;
      } else {
        e = t;
      }
    }
    
    return n;
  }


  /*
   * Run application table td callback
   */

  
  function runApp( event ) {
    event = event || window.event;
    var e = event.target || event.srcElement;
    var n = findAppName( e );
    var request = '?action=runApp&name=' + n;
    
    // prevent multiple clicks
    $( 'table tbody #runApp' ).off( 'click', runApp );
    
    $.ajax( {
      url : $addr + $action + request,
      type : 'GET',
      dataType : 'json',
      async : true,
      cache : false
    } )
    .done( function( data, textStatus, jqXHR ) {

      if ( data.name ) {
        /*
          additional fields:
            result: command return value
        */
        var news, icon, title;

        if ( data.result == 1 ) {
          news = ' completed successfully! ';
          icon = $icon_check;
          title = $title_done;
        } else {
          news = ' failed! ';
          icon = $icon_alert;
          title = $title_error;
        }
        
        var msg = $( '<div>Command `'+ data.name + "'" + news + '<br />See ' + '</div>' );
        /*
         * XXX: this is fucking shit
         */
        msg.append(
          $( '<a class="xlink">logs</a>' ).click( function() {
            var url = $addr + $action + '?action=getLogs&name=' + data.name;
            
            $.ajax( {
              url : url,
              type : 'GET',
              dataType : 'JSON',
              async : true,
              cache : false
            } )
            .done( function( data, textStatus, jqXHR ) {
              // data = { name => xxx, stdout => text, stderr => text }
              if ( data.name ) {
                showLogsWindow( data.name, data.stdout, data.stderr );
              } else {
                showMessageCloned( $title_error, $errors[ data.err ] );
              }
              
            } )
            .fail( function( xhr, textStatus, errorThrown ) {
              showMessageCloned( $title_error, $errors[ 0 ] );
            } );
            
          } )
        );
        msg.append( ' for details.' );
        
        showMessage( title, msg );
      } else {
        showMessage( $title_error, $errors[ data.err ] );
      }
      
      $( 'table tbody #runApp' ).click( runApp );
    } )
    .fail( function( data, textStatus, errorThrown ) {
      showMessage( $title_error, $errors[ 0 ] );
      $( 'table tbody #runApp' ).click( runApp );      
    } );
    
    return false;
  }
  
  
  /*
   * Set events on tbody tr td
   */
   
  
  function setCellEvents() {
    $( 'table tbody tr td' ).click( showEntry );
    $( 'table tbody #runApp' ).off( 'click', showEntry ).click( runApp );  
  }


  /*
   * A callback for entry: show dialog window
   */
   

  function showEntry( event ) {
    event = event || window.event;
    var e = event.target || event.srcElement;
    var n = findAppName( e );
    var request = '?action=getApp&name=' + n;
    
    $.ajax( {
      url : $addr + $action + request,
      type : 'GET',
      async : true,
      dataType : 'json',
      cache : false
    } )
    .done( function( data, textStatus, jqXHR ) {
      if ( data.name ) {
        /*
          $( "#editAppForm" ).serialize() does not contains a
          field with disabled attribute in input field.
          duplicate this entry and made it hidden.
        */
        $( '#editAppForm #name' ).val( data.name );
        $( '#editAppForm #name-ui' ).val( data.name );
        $( '#editAppForm #cmd' ).val( data.cmd );
        $( '#editAppForm #user' ).val( data.user );
        editor.dialog( 'open' );
      } else {
        showMessage( $title_error, $errors[ data.err ] );
      }
    } )
    .fail( function( data, textStatus, errorThrown ) {
      showMessage( $title_error, $errors[ 0 ] );
    } );
  }

  
  /*
   * Fetch entries from a server
   */

  
  function loadEntries() {
    // clean previous records
    tbody.empty();
    table.trigger( 'updateAll' );
    
    // ask server about records
    var request = '?action=listApps';
    
    $.ajax( {
      url : $addr + $action + request,
      type : 'GET',
      async : true,
      dataType : 'json',
      cache : false
    } )
    .done( function( data, textStatus, jqXHR ) {
      /* data is an array of hashes
       * add entries from the data object to a table
       */
      var entries = data.length;
      var row, $row;
      for (var i = 0; i < entries; i++) {
        var entry = data[ i ],
        row = '<tr><td>'  + entry.name 
            + '</td><td>' + entry.user
            + '</td><td>' + entry.cmd  
            + '</td><td id="runApp">' + $icon_play + '</td></tr>',
        $row = $( row );
        table.find( 'tbody' ).append( $row )
        .trigger( 'addRows', [ $row, false ] );
      }
      
      // register on click event to show dialog window
      // about an entry
      setCellEvents();
      
      // update table internal structures
      table
      .trigger( 'update', [ [[ 0, 0 ]] ] )
      .trigger( 'refreshWidgets' ); // zebra widget fix

      return false;
    } )
    .fail( function( data, textStatus, errorThrown ) {
      showMessage( $title_error, $errors[ 0 ] );
    } );

    return false;
  }


  /*
   * Clear entries in the table
   */

  
  function flushTable() {
    $( 'table tbody' ).empty();
    $( 'table' ).trigger( "updateAll", [ true ] );
    return false;
  }

  
  /*
   * Show logs dialog window with accordion widget
   */


  function showLogsWindow( name, stdout, stderr ) {
    var selector = '#log-window';
    
    var accordion = $( '<div id="accordion"></div>' );
    accordion.append( '<h3>Output</h3><div><pre style="padding: 0; margin: 0">'
                      + stdout + '</pre></div>' );
    accordion.append( '<h3>Errors</h3><div><pre style="padding: 0; margin: 0">'
                      + stderr + '</pre></div>' );
  
    var log = $( selector ).dialog( {
      dialogClass: "no-close",
      modal : true,
      autoOpen : false,
      title : 'Logs of `' + name + "'",
      width : 800,
      height : 600,
      buttons : {
        Ok : function() {
          $( this ).dialog( "close" );
        }
      },
      close : function() {
        $( selector ).empty();
      },
      resize : function ( event, ui ) {
        $( '#accordion' ).accordion( "refresh" );
      },
      open : function ( event, ui ) {
        $( '#accordion' ).accordion( { 
          collapsible: true,
          heightStyle: "fill"
        } );       
      }
    } );
  
    log.append( accordion ).dialog( 'open' );
  }

  
  /*
   * Initialize a dialog form to create app
   */ 


  dialog = $( "#add-form" ).dialog( {
    dialogClass: "no-close",
    autoOpen: false,
    heigth: 300,
    width: 400,
    maxWidth: 600,
    modal: true,
    buttons: {
      "Create" : createApp,
      "Cancel" : function() {
        dialog.dialog( "close" );
      }
    },
    close: function() {
      $( '#addAppForm' )[ 0 ].reset();
      tips.text( "All form fields are required." );
      $( '#addAppForm :input' ).removeClass( "ui-state-error" );
    }
  } );
  
  
  /*
   * Initialize addAppForm form
   */


  form = dialog.find( "#addAppForm" ).on( "submit", function( event ) {
    event.preventDefault();
    createApp();
  } );


  /*
   * Initialize a dialog form to edit app
   */ 


  editor = $( "#edit-form" ).dialog( {
    dialogClass: "no-close",
    autoOpen: false,
    heigth: 300,
    width: 400,
    maxWidth: 600,
    modal: true,
    buttons: {
      "Save" : editApp,
      "Delete" : delApp,
      "Cancel" : function() {
        editor.dialog( "close" );
      }
    },
    close: function() {
      $( '#editAppForm' )[0].reset();
      tips.text( "All form fields are required." );
      $( '#editAppForm :input' ).removeClass( "ui-state-error" );
    }
  } );

  
  /*
   * Initialize buttons
   */


  $( "#create-app" )
    .button( {
      icons: { primary: "ui-icon-plus" }
    } )
    .on( "click", function() {
      dialog.dialog( "open" );
    } );
    
  $( "#wipe-apps" )
    .button( {
      icons: { primary: "ui-icon-trash" }
    } )
    .on( "click", function() {
      var msg = "This action will wipes all records from the server. Continue?";

      confirmDialog( msg, function() {
        $.ajax( {
          url: $addr + $action,
          type: "POST",
          async: true,
          data: { action: "wipeApps" },
          dataType: "json",
          cache: false,
        } )
        .done( function ( data, textStatus, jqXHR ) {
          flushTable();

          var msg = "<p>" + $icon_check + "Wiped " + data.wiped + " record(s).</p>";
          showMessage( $title_done, msg );
        } )
        .fail( function ( xhr, textStatus, errorThrown ) {
          showMessage( $title_error, $errors[ 0 ] );
        } );
       
        return false;
      } );
    } );

  
  /*
   * Apllications table setup
   */


  // Extend the themes to change any of the default class names
  $.extend( $.tablesorter.themes.jui, {
    // change default jQuery uitheme icons - find the full list of icons at
    // http://jqueryui.com/themeroller/ (hover over them for their name)
    table        : 'ui-widget ui-widget-content ui-corner-all', // table classes
    caption      : 'ui-widget-content',
    // header class names
    header       : 'ui-widget-header ui-corner-all ui-state-default', // header classes
    sortNone     : '',
    sortAsc      : '',
    sortDesc     : '',
    active       : 'ui-state-active', // applied when column is sorted
    hover        : 'ui-state-hover',  // hover class
    // icon class names
    icons        : 'ui-icon', // icon class added to the <i> in the header
    iconSortNone : 'ui-icon-carat-2-n-s', // class name added to icon when column is not sorted
    iconSortAsc  : 'ui-icon-carat-1-n', // class name added to icon when column has ascending sort
    iconSortDesc : 'ui-icon-carat-1-s', // class name added to icon when column has descending sort
    filterRow    : '',
    footerRow    : '',
    footerCells  : '',
    even         : 'ui-widget-content', // even row zebra striping
    odd          : 'ui-state-default'   // odd row zebra striping
  } );

  // call the tablesorter plugin and apply the ui theme widget
  table.tablesorter( {
    widthFixed: false,
    sortList: [
      [ 0, 0 ],
    ],
    theme : 'jui', // theme "jui" and "bootstrap" override the uitheme widget option in v2.7+
    headerTemplate : '{content} {icon}', // needed to add icon for jui theme
    // widget code now contained in the jquery.tablesorter.widgets.js file
    widgets : [ 'uitheme', 'zebra' ],
    widgetOptions : {
      // zebra striping class names - the uitheme widget adds the class names defined in
      // $.tablesorter.themes to the zebra widget class names
      zebra   : ["even", "odd"],
      // set the uitheme widget to use the jQuery UI theme class names
      // ** this is now optional, and will be overridden if the theme name exists in $.tablesorter.themes **
      // uitheme : 'jui'
    }
  } );

  
  // fill the table first
  loadEntries();

   
} ); // document.ready
</script>


<div id="add-form" title="Add new application">
  <p class="validateTips">All form fields are required.</p>

  <form action="/plwrd" method="post" id="addAppForm">
    <fieldset>
      <label for="name">Name</label>
      <input type="text" name="name" id="name" value="ls" 
            class="text ui-widget-content ui-corner-all">
      <label for="user">User</label>
      <input type="text" name="user" id="user" value="nobody"
            class="text ui-widget-content ui-corner-all">
      <label for="cmd">Command</label>
      <input type="text" name="cmd" id="cmd" value="/bin/ls"
            class="text ui-widget-content ui-corner-all">
      <input type="hidden" name="action" value="addApp">
    </fieldset>
  </form>
</div>

<div id="edit-form" title="Edit application">
  <p class="validateTips">All form fields are required.</p>

  <form action="/plwrd" method="post" id="editAppForm">
    <fieldset>
      <label for="name">Name</label>
      <input type="text" name="name-ui" id="name-ui"
            class="text ui-widget-content ui-corner-all" disabled>
      <label for="user">User</label>
      <input type="text" name="user" id="user"
            class="text ui-widget-content ui-corner-all">
      <label for="cmd">Command</label>
      <input type="text" name="cmd" id="cmd"
            class="text ui-widget-content ui-corner-all">
      <input type="hidden" name="action" value="editApp">
      <input type="hidden" name="name" id="name">
    </fieldset>
  </form>
</div>

<button id="create-app">Add</button>
<button id="wipe-apps">Wipe</button>

<table class="tablesorter">
  <colgroup><col><col><col><col width="1%"></colgroup>
  <thead>
    <tr>
      <th>Name</th>
      <th>User</th>
      <th>Application</th>
      <th><!-- micro buttons //--></th>
    </tr>
  </thead>
  <!-- data placeholder //-->
  <tbody>
  <!--
    <tr>
      <td>test</td>
      <td>admin</td>
      <td>dont delete</td>
      <td>&nbsp;</td>
    </tr>
  //-->
  </tbody>
</table>

<!-- dialog window with error, notification messages //-->
<div id="message" title="Message window"></div>

<!-- yes/no dialog //-->
<div id="yesno" title="Confirmation"></div>

<!-- logs window //-->
<div id="log-window"></div>
