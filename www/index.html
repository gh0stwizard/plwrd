<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="plwrd - Perl Web Run Daemon">
  <meta name="keywords" content="application, runner, perl, knockout">
  <meta name="author" content="gh0stwizard">
  <meta charset="utf-8">
  <title>plwrd &part; Application Manager &forall;</title>
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <script type="text/javascript" src="/js/knockout-3.4.0.js"></script>
  <script type="text/javascript" src="/js/zepto.min.js"></script>
  <script type="text/javascript" src="/js/signals.min.js"></script>
  <script type="text/javascript" src="/js/crossroads.min.js"></script>
  <script type="text/javascript" src="/js/hasher.min.js"></script>
</head>
<style type="text/css">

html, body, button {
  font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
  font-size: 1.0em;
}

table {
  width: 100%;
}

/* 
 * Table style from
 *   http://www.smashingmagazine.com/2008/08/13/top-10-css-table-designs/
 */

#AppsTable {
  font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
  font-size: 1.0em;
  margin-top: 15px;
  text-align: left;
  border-collapse: collapse;
}
#AppsTable th, #AppTable th {
  font-size: 1.2em;
  font-weight: normal;
  padding: 12px 15px;
  color: #039;
  text-align: left;
}
#AppsTable td {
  padding: 10px 15px;
  color: #669;
  border-top: 1px solid #e8edff;
  cursor: default;
}
#AppsTable tr:hover td {
  color: #339;
  background: #eff2ff;
}

/*
 * http://css3buttongenerator.com/
 */

.btn {
  color: #ffffff;
  font-size: 0.85em;
  background: #16167a;
  padding: 7px 20px 7px 20px;
  text-decoration: none;
  border: 0;
}
.btn:hover {
  background: #000290;
}


/* prevent color changing for links */

#AppsTable tr td a,
#AppsTable tr td a:visited {
  color: blue;
}

/* error message style */
.errorBox p {
  text-align: center;
  font-size: 1.4em;
  font-weight: bolder;
}


/* table for application info */

#AppTable {
  margin-top: 15px;
  text-align: left;
  border-collapse: collapse;
}
#AppTable th {
  text-align: right;
}
#AppTable td {
  padding: 10px 15px;
  color: #669;
  border-bottom: 1px solid #e8edff;	
}
#AppTable td.editable {
  padding: 0 15px;
}
#AppTable td input {
  font-size: 1.2em;
  border: 0;
  padding: 0;
  margin: 0;
  width: 100%;
}
#AppTable td.bless,
#AppTable td.button {
  border: 0;
}
#AppTable td.button {
  padding-top: 24px;
}
#AppTable th.buttomline {
  border-bottom: 1px solid #e8edff;
}


/* Add application styles */

.AddApp,
.viewWipeApps,
.appLog,
.viewApp,
.viewApps,
.viewAddApp,
.viewEditApp {
  left: 0;
  right: 0;
  width: 90%;
  margin: 0 auto;
  max-width: 1280px;
}
.AddApp button {
  margin-left: 18px;
}
.AddApp img {
  height: 24px;
  width: 24px;
  padding-top: 5px;
  padding-right: 5px;
}


/* wipe applications page */

.viewWipeApps {
  padding-left: 10px;
  padding-top: 15px;
}


/* Output, errors log settings */

.appLog p {
  font-size: 1.2em;
  color: #039;
  font-weight: bolder;
}
.log {
  text-align: left;
  background: black;
  color: white;
  overflow-x: auto;
}
.log pre {
  font-family: "Lucida Console", Monaco, monospace;
  padding: 0 5px;
  font-size: 1.0em;
  font-weight: normal;
}

</style>
<body>

  <!-- Header //-->
  <div class="AddApp" aling="center">
      <button class="btn" data-bind="click: showApps">Applications</button>
      <button class="btn" data-bind="click: addNewApp">Create App</button>
      <button class="btn" data-bind="click: wipeAppsAsk">Wipe Apps</button>
      <!-- http://spiffygif.com //-->
      <img src="/img/spiffygif.gif" align="right" data-bind="visible: onAJAX()" />
  </div>

  <!-- Error message box //-->
  <div class="errorBox" data-bind="with: errorMessage">
    <p><span data-bind="text: $data"></span></p>
  </div>

  <!-- Applications table //-->
  <div class="viewApps" data-bind="visible: chosenListAppsData().length > 0">
    <table id="AppsTable" align="center" data-bind="with: chosenListAppsData">
      <colgroup>
        <col width="15%">
        <col width="65%">
        <col><col><col><col>
      </colgroup>
      <thead>
        <tr>
          <th>Name</th>
          <th>Command</th>
          <th colspan="4">&nbsp;</th>
        </tr>
      </thead>
      <tbody data-bind="foreach: $data">
        <tr>
          <td data-bind="text: name"></td>
          <td data-bind="text: cmd"></td>
          <td><a href="#" data-bind="click: $root.runApp"
                title="Run an application">Run</a></td>
          <td><a href="#" data-bind="click: $root.showAppLog"
                title="Show last log">Log</a></td>
          <td><a href="#" data-bind="click: $root.editApp"
                title="Edit an application">Edit</a></td>
          <td><a href="#" data-bind="click: $root.removeApp"
                title="Remove an application">Remove</a></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Application information data //-->
  <div class="viewApp" data-bind="with: chosenAppData">
    <table id="AppTable" align="center">
      <colgroup><col width="15%"><col></colgroup>
      <tbody>
        <tr>
          <th>Name</th>
          <td data-bind="text: name"></td>
        </tr>
        <tr data-bind="with: $root.formattedStatus()">
          <th>Status</th>
          <td data-bind="text: $root.formattedStatus()"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Application log //-->
  <div class="viewAppLog" data-bind="with: formattedLogs">
    <div class="appLog" align="center" data-bind="visible: stdout">
      <p>Output</p>
      <div class="log"><pre data-bind="text: stdout"></pre></div>
    </div>
    <div class="appLog" align="center" data-bind="visible: stderr">
      <p>Errors</p>
      <div class="log"><pre data-bind="text: stderr"></pre></div>
    </div>
  </div>

  <!-- Edit application form //-->
  <div class="viewEditApp" data-bind="with: chosenAppDataEdit">
    <table id="AppTable" align="center">
      <colgroup><col width="15%"><col></colgroup>
      <tbody>
        <tr>
          <th>Name</th>
          <td data-bind="text: name"></td>
        </tr>
        <tr>
          <th>Command</th>
          <td class="editable"><input data-bind="value: cmd" /></td>
        </tr>
        <tr>
          <td class="button">&nbsp;</td>
          <td class="button">
            <button class="btn" data-bind="click: $root.updateApp">Submit</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Create new application form //-->
  <div class="viewAddApp" data-bind="visible: onCreateApp">
    <table id="AppTable" align="center">
      <colgroup><col width="15%"><col></colgroup>
      <tbody>
        <tr>
          <th>Name</th>
          <td class="editable"><input data-bind="value: newAppName" /></td>
        </tr>
        <tr>
          <th>Command</th>
          <td class="editable"><input data-bind="value: newAppCmd" /></td>
        </tr>
        <tr>
          <td class="button">&nbsp;</td>
          <td class="button">
            <button class="btn" data-bind="click: $root.addApp">Submit</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Wipe applications form //-->
  <div class="viewWipeApps" data-bind="visible: onWipeApps">
    <h1>Attention!</h1>
    <p>By pressing submit button you are accept to wipe 
       all applications from the server.</p>
    <button class="btn" data-bind="click: $root.wipeAppsBtn">Submit</button>
  </div>

</body>
<script>
  var suffix = '/plwrd',
      ra = window.location.protocol + '//' + window.location.host + suffix + '?',
      nameRegex = /^[a-z]([0-9a-z_\-\.])+$/i;

  function sortByName( a, b ) {
    return ( a.name == b.name ) ? 0 : ( a.name < b.name ? -1 : 1 );
  }

  ko.bindingHandlers.showMe = {
    init: function ( element, valueAccessor ) {
      var shouldDisplay = valueAccessor();
      $( element ).toggle( shouldDisplay );
    },
    update: function ( element, valueAccessor ) {
      var shouldDisplay = valueAccessor();
      shouldDisplay ? $( element ).show() : $( element ).hide();
    }
  };

  function AppViewModel() {
    var self = this;

    // Data

    self.chosenListAppsData = ko.observableArray( [] );
    self.chosenAppData = ko.observable();
    self.logAppData = ko.observable();
    self.chosenAppDataEdit = ko.observable();
    self.errorMessage = ko.observable();
    self.commandStatus = ko.observable();
    self.onCreateApp = ko.observable();
    self.newAppName = ko.observable();
    self.newAppCmd = ko.observable();
    self.onAJAX = ko.observable();
    self.onWipeApps = ko.observable();

    self.errors = [
      'Connection error',
      'Bad request',
      'Not implemented',
      'Internal error',
      'Duplicate entry in a database',
      'Not found'
    ];


    // Behaviours

    self.showApps = function () {
      location.hash = '';
    }

    self.addNewApp = function () {
      location.hash = 'create';
    }

    self.addApp = function () {
      var name = self.newAppName(),
          cmd = self.newAppCmd(),
          valid = true;

      valid = valid && checkLength( name, 'Name', 2, 16 );
      valid = valid && checkRegexp( name, nameRegex, 'Name' );
      valid = valid && checkLength( cmd, 'Command', 1, 255 );

      valid && postJSON( suffix,
        {
          action: 'addApp',
          name: name,
          cmd: cmd
        },
        function ( data ) {
          if ( data.err ) {
            self.errorMessage( self.errors[ data.err ] );
          } else {
            self.newAppName( null );
            self.newAppCmd( null );
            self.onCreateApp( null );
            // get back to main page
            hasher.setHash( '' );
          }
        }
      );
    }

    self.runApp = function ( app ) {
      location.hash = 'run' + '/' + app.name;
    };

    self.showAppLog = function ( app ) {
      location.hash = 'log' + '/' + app.name;
    };

    self.editApp = function( app ) {
      location.hash = 'edit' + '/' + app.name;
    };

    self.wipeAppsAsk = function () {
      location.hash = 'wipe/apps';
    };

    self.wipeAppsBtn = function () {
      postJSON( suffix,
        { 
          action: 'wipeApps'
        },
        function ( data ) {
          if ( data.err ) {
            self.errorMessage( self.errors[ data.err ] );
          } else {
            // get back to main page
            hasher.setHash( '' );
          }
        }
      );
    };

    self.removeApp = function ( app )  {
      var name = app.name;

      postJSON( suffix,
        {
          action: 'delApp',
          name: name
        },
        function( data ) {
          if ( data.err ) {
            self.errorMessage( self.errors[ data.err ] );
          } else {
            // remove from a table
            self.chosenListAppsData.remove( app );
          }
        }
      );
    };

    self.updateApp = function ( app ) {
      postJSON( suffix,
        { 
          action: 'editApp',
          name: app.name,
          cmd: app.cmd
        },
        function ( data ) {
          // clear form
          self.chosenAppDataEdit( null );

          if ( data.err ) {
            self.errorMessage( self.errors[ data.err ] );
          } else {
            // get back to main page
            hasher.setHash( '' );
          }
        }
      );
    };

    self.createApp = function ( app ) {
      postJSON( suffix,
        { 
          action: 'addApp',
          name: app.name,
          cmd: app.cmd
        },
        function ( data ) {
          if ( data.err ) {
            self.errorMessage( self.errors[ data.err ] );
          } else {
            // get back to main page
            hasher.setHash( '' );
          }
        }
      );
    };


    // Formaters

    self.formattedLogs = ko.computed( function () {
      var logs = self.logAppData();

      if ( logs ) {
        // http://stackoverflow.com/questions/20964811/replace-amp-to-lt-to-and-gt-to-gt-in-javascript
        logs['stdout'] = $( '<div/>' ).html(logs['stdout'] ).text();
        logs['stderr'] = $( '<div/>' ).html(logs['stderr'] ).text();
      }

      return logs;
    } );

    self.formattedStatus = ko.computed( function() {
      var status = self.commandStatus();

      if ( status == null || status == undefined ) {
        return null;
      }

      return status ? 'Success' : 'Failed';
    } );


    // Helpers
    
    function cleanAll () {
      self.chosenListAppsData( [] );
      self.chosenAppData( null );
      self.logAppData( null );
      self.chosenAppDataEdit( null );
      self.commandStatus( null );
      self.onCreateApp( null );
      self.errorMessage( null );
      self.onWipeApps( null );
    }

    function getJSON ( url, cb ) {
      var numr = self.onAJAX() ? self.onAJAX() : 0;
      self.onAJAX( numr + 1 );

      $.ajax( {
        type: 'GET',
        url: url,
        dataType: 'json',
        cache: false,
        success: cb,
        error: function ( xhr, type, error ) {
          cleanAll();
          self.errorMessage( error );
        },
        complete: function () {
          var num = self.onAJAX() ? self.onAJAX() : 1;
          self.onAJAX( num - 1 );
        }
      } );
    }

    function postJSON( url, data, cb ) {
      var numr = self.onAJAX() ? self.onAJAX() : 0;
      self.onAJAX( numr + 1 );

      $.ajax( {
        type: 'POST',
        url: url,
        data: data,
        dataType: 'json',
        success: cb,
        error: function ( xhr, type, error ) {
          cleanAll();
          self.errorMessage( error );
        },
        complete: function () {
          var num = self.onAJAX() ? self.onAJAX() : 1;
          self.onAJAX( num - 1 );
        }
      } );
    }

    function makeRequest( action, name, cb ) {
      getJSON( ra + 'action=' + action + '&name=' + name, function( data ) {
        if ( data.err == null ) {
          cb( data );
        } else {
          self.errorMessage( self.errors[ data.err ] );
        }
      } );
    }

    function checkLength( o, n, min, max ) {
      if ( o == null || o == undefined ) {
        o = '';
      }

      if ( o.length > max || o.length < min ) {
        self.errorMessage( "Length of " + n + " must be between " 
                          + min + " and " + max );
        return false;
      } else {
        return true;
      }
    }

    function checkRegexp( o, regexp, n ) {
      if ( o == null || o == undefined ) {
        o = '';
      }

      if ( !( regexp.test( o ) ) ) {
        self.errorMessage( n + " contains invalid characters" );
        return false;
      } else {
        return true;
      }
    }


    // Router functions

    function listApps() {
      getJSON( ra + 'action=listApps', function( data ) {
        if ( data.err == null ) {
          self.chosenListAppsData( data );
          self.chosenListAppsData.sort( sortByName );
        } else {
          self.errorMessage( self.errors[ data.err ] );
        }
      } );
    }

    function getApp ( name, cb ) {
      makeRequest( 'getApp', name, cb );
    }

    function getAppLogs( name, cb ) {
      makeRequest( 'getLogs', name, cb );
    }

    function showAppLog ( name ) {
      getApp( name, self.chosenAppData );
      getAppLogs( name, self.logAppData );
    }

    function runApp ( name ) {
      getApp( name, self.chosenAppData );
      makeRequest( 'runApp', name, function ( data ) {
        self.commandStatus( data.result ? true : false ); // 1: ok, 0: an error
        getAppLogs( name, self.logAppData );
      } );
    }

    function createApp () {
      cleanAll();
      self.onCreateApp( true );
    }

    function wipe ( name ) {
      if ( name == 'apps' ) {
        cleanAll();
        self.onWipeApps( true );
      }
    }


    // Setup routers

    crossroads.addRoute( '', listApps );
    crossroads.addRoute( '/', listApps );
    crossroads.addRoute( 'create', createApp );
    var actionsRouter = crossroads.addRoute( '{action}/{name}' );

    actionsRouter.matched.add( function( action, name ) {
      self.chosenListAppsData( [] );
      self.logAppData( null );
      self.chosenAppDataEdit( null );

      switch ( action ) {
        case 'edit':
          self.chosenAppData( null );
          getApp( name, self.chosenAppDataEdit );
          break;
        case 'log':
          showAppLog( name );
          break;
        case 'run':
          runApp( name );
          break;
        case 'wipe':
          wipe( name );
          break;
        default:
          listApps();
      }
    } );


    // Setup hasher

    function parseHash( newHash, oldHash ) {
      // location has been switched to '/'
      if ( newHash == undefined || newHash === "" ) {
        self.chosenAppData( null );
        self.logAppData( null );
        self.chosenAppDataEdit( null );
        self.commandStatus( null );
        self.onCreateApp( null );
        self.errorMessage( null );
        self.onWipeApps( null);
      }

      crossroads.parse( newHash );
    }

    hasher.initialized.add( parseHash ); //parse initial hash
    hasher.changed.add( parseHash ); //parse hash changes
    hasher.init(); //start listening for history change
  }

  ko.applyBindings( new AppViewModel() );
</script>
</html>
